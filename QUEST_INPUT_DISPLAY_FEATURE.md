# Questè¾“å…¥æ³• - å¯äº¤äº’è¾“å…¥æ¡†æ˜¾ç¤ºåŠŸèƒ½

## åŠŸèƒ½æ¦‚è¿°

ä¸ºäº†è§£å†³åœ¨Questç³»ç»Ÿä¸­æ— æ³•çœ‹åˆ°å½“å‰è¾“å…¥æ¡†å†…å®¹çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šæ–¹æ·»åŠ äº†ä¸€ä¸ªå®Œå…¨å¯äº¤äº’çš„è¾“å…¥åŒºåŸŸï¼Œç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸­ç›´æ¥ç¼–è¾‘æ–‡æœ¬ï¼Œæ‰€æœ‰æ“ä½œéƒ½ä¼šå®æ—¶åŒæ­¥åˆ°åŸå§‹è¾“å…¥æ¡†ã€‚

## å®ç°çš„åŠŸèƒ½

### 1. å®Œå…¨å¯äº¤äº’çš„è¾“å…¥ä½“éªŒ
- **ç‚¹å‡»å®šä½**: ç”¨æˆ·å¯ä»¥ç‚¹å‡»æ–‡æœ¬ä¸­çš„ä»»æ„ä½ç½®æ¥å®šä½å…‰æ ‡
- **ç›´æ¥ç¼–è¾‘**: å¯ä»¥ç›´æ¥åœ¨æ˜¾ç¤ºåŒºåŸŸä¸­è¾“å…¥ã€åˆ é™¤ã€ä¿®æ”¹æ–‡æœ¬
- **é€‰æ‹©æ“ä½œ**: æ”¯æŒæ–‡æœ¬é€‰æ‹©ã€å¤åˆ¶ã€ç²˜è´´ç­‰æ“ä½œ
- **å®æ—¶åŒæ­¥**: æ‰€æœ‰æ“ä½œéƒ½ä¼šç«‹å³åŒæ­¥åˆ°åŸå§‹è¾“å…¥æ¡†

### 2. åŒå‘åŒæ­¥æœºåˆ¶
- **æ˜¾ç¤ºåŒºåŸŸ â†’ åŸå§‹è¾“å…¥æ¡†**: åœ¨æ˜¾ç¤ºåŒºåŸŸçš„æ‰€æœ‰ç¼–è¾‘æ“ä½œéƒ½ä¼šåŒæ­¥åˆ°åŸå§‹è¾“å…¥æ¡†
- **åŸå§‹è¾“å…¥æ¡† â†’ æ˜¾ç¤ºåŒºåŸŸ**: åŸå§‹è¾“å…¥æ¡†çš„å†…å®¹å˜åŒ–ä¹Ÿä¼šåŒæ­¥åˆ°æ˜¾ç¤ºåŒºåŸŸ
- **å…‰æ ‡åŒæ­¥**: å…‰æ ‡ä½ç½®åœ¨ä¸¤ä¸ªåŒºåŸŸä¹‹é—´ä¿æŒåŒæ­¥
- **é˜²å¾ªç¯æ›´æ–°**: æ™ºèƒ½é˜²æ­¢ä¸¤ä¸ªåŒºåŸŸä¹‹é—´çš„æ— é™å¾ªç¯æ›´æ–°

### 3. æ™ºèƒ½å†…å®¹ç®¡ç†
- **å®Œæ•´å†…å®¹**: æ˜¾ç¤ºå…‰æ ‡å‰åçš„å®Œæ•´æ–‡æœ¬å†…å®¹
- **å®æ—¶æ›´æ–°**: å½“ä»»ä¸€åŒºåŸŸå†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç«‹å³æ›´æ–°å¦ä¸€åŒºåŸŸ
- **å®¹é”™å¤„ç†**: å¼‚å¸¸æƒ…å†µä¸‹æœ‰å®Œå–„çš„å®¹é”™æœºåˆ¶

### 3. ä¸»é¢˜é€‚é…
- è‡ªåŠ¨é€‚é…æ·±è‰²/æµ…è‰²ä¸»é¢˜
- ä¸é”®ç›˜æ•´ä½“é£æ ¼ä¿æŒä¸€è‡´
- æ¸…æ™°çš„è§†è§‰å±‚æ¬¡

## æŠ€æœ¯å®ç°

### ä¿®æ”¹çš„æ–‡ä»¶

1. **å¸ƒå±€æ–‡ä»¶**: `yuyansdk/src/main/res/layout/sdk_skb_container.xml`
   - æ·»åŠ äº†æ–°çš„SelectionAwareEditTextç»„ä»¶ç”¨äºå¯äº¤äº’è¾“å…¥
   - è®¾ç½®äº†åˆé€‚çš„å°ºå¯¸å’Œæ ·å¼ï¼Œæ”¯æŒè§¦æ‘¸å’Œç¼–è¾‘

2. **ä¸»è¦é€»è¾‘**: `yuyansdk/src/main/java/com/yuyan/imemodule/keyboard/InputView.kt`
   - æ·»åŠ äº† `mCurrentInputDisplay` æˆå‘˜å˜é‡ï¼ˆSelectionAwareEditTextç±»å‹ï¼‰
   - å®ç°äº† `setupCurrentInputDisplay()` æ–¹æ³•è®¾ç½®äº¤äº’åŠŸèƒ½
   - å®ç°äº† `updateCurrentInputDisplay()` æ–¹æ³•åŒæ­¥å†…å®¹
   - æ·»åŠ äº†åŒå‘åŒæ­¥æœºåˆ¶å’Œé˜²å¾ªç¯æ›´æ–°é€»è¾‘

3. **è‡ªå®šä¹‰ç»„ä»¶**: `yuyansdk/src/main/java/com/yuyan/imemodule/view/widget/SelectionAwareEditText.kt`
   - åˆ›å»ºäº†æ”¯æŒé€‰æ‹©å˜åŒ–ç›‘å¬çš„è‡ªå®šä¹‰EditText
   - ä¼˜åŒ–äº†è¾“å…¥æ³•è§¦å‘æœºåˆ¶

4. **èµ„æºæ–‡ä»¶**: `yuyansdk/src/main/res/values/ids.xml`
   - æ·»åŠ äº†æ–°çš„IDèµ„æº

### å…³é”®ä»£ç é€»è¾‘

#### 1. è®¾ç½®äº¤äº’åŠŸèƒ½
```kotlin
/**
 * è®¾ç½®å½“å‰è¾“å…¥æ˜¾ç¤ºåŒºåŸŸçš„äº¤äº’åŠŸèƒ½
 */
private fun setupCurrentInputDisplay() {
    // è®¾ç½®æ–‡æœ¬å˜åŒ–ç›‘å¬å™¨
    mCurrentInputDisplay.addTextChangedListener(object : TextWatcher {
        override fun afterTextChanged(s: Editable?) {
            if (!isUpdatingDisplayFromOriginal && s != null) {
                // ç”¨æˆ·åœ¨æ˜¾ç¤ºåŒºåŸŸä¸­ä¿®æ”¹äº†æ–‡æœ¬ï¼Œéœ€è¦åŒæ­¥åˆ°åŸå§‹è¾“å…¥æ¡†
                syncDisplayToOriginalInput(s.toString())
            }
        }
    })

    // è®¾ç½®é€‰æ‹©å˜åŒ–ç›‘å¬å™¨
    mCurrentInputDisplay.setOnSelectionChangedListener { selStart, selEnd ->
        if (!isUpdatingDisplayFromOriginal) {
            syncCursorToOriginalInput(selStart, selEnd)
        }
    }
}
```

#### 2. åŒå‘åŒæ­¥æœºåˆ¶
```kotlin
/**
 * å°†æ˜¾ç¤ºåŒºåŸŸçš„æ–‡æœ¬åŒæ­¥åˆ°åŸå§‹è¾“å…¥æ¡†
 */
private fun syncDisplayToOriginalInput(newText: String) {
    if (isUpdatingOriginalFromDisplay) return

    try {
        isUpdatingOriginalFromDisplay = true

        // è·å–å½“å‰åŸå§‹è¾“å…¥æ¡†çš„å†…å®¹
        val currentText = getCurrentInputText()

        if (currentText != newText) {
            // æ¸…é™¤åŸå§‹è¾“å…¥æ¡†å†…å®¹å¹¶è®¾ç½®æ–°å†…å®¹
            service.currentInputConnection?.deleteSurroundingText(1000, 1000)
            service.currentInputConnection?.commitText(newText, 1)

            // åŒæ­¥å…‰æ ‡ä½ç½®
            val cursorPos = mCurrentInputDisplay.selectionStart
            service.currentInputConnection?.setSelection(cursorPos, cursorPos)
        }
    } finally {
        isUpdatingOriginalFromDisplay = false
    }
}
```

### åŒæ­¥è§¦å‘ç‚¹

#### ä»åŸå§‹è¾“å…¥æ¡†åˆ°æ˜¾ç¤ºåŒºåŸŸçš„åŒæ­¥ï¼š
- é”®ç›˜åˆå§‹åŒ–æ—¶
- æ–‡æœ¬æäº¤åˆ°è¾“å…¥æ¡†æ—¶ (commitText)
- åˆ é™¤æ–‡æœ¬æ—¶ (åˆ é™¤é”®ã€æ¸…é™¤æ“ä½œ)
- å›è½¦é”®æ“ä½œæ—¶
- å…‰æ ‡ä½ç½®æ”¹å˜æ—¶ (onUpdateSelection)
- ä¸»é¢˜åˆ‡æ¢æ—¶

#### ä»æ˜¾ç¤ºåŒºåŸŸåˆ°åŸå§‹è¾“å…¥æ¡†çš„åŒæ­¥ï¼š
- ç”¨æˆ·åœ¨æ˜¾ç¤ºåŒºåŸŸä¸­è¾“å…¥æ–‡å­—æ—¶
- ç”¨æˆ·åœ¨æ˜¾ç¤ºåŒºåŸŸä¸­åˆ é™¤æ–‡å­—æ—¶
- ç”¨æˆ·ç‚¹å‡»æˆ–æ‹–æ‹½æ”¹å˜å…‰æ ‡ä½ç½®æ—¶
- ç”¨æˆ·é€‰æ‹©æ–‡æœ¬æ—¶

**é˜²å¾ªç¯æœºåˆ¶**: ä½¿ç”¨ `isUpdatingDisplayFromOriginal` å’Œ `isUpdatingOriginalFromDisplay` æ ‡å¿—é˜²æ­¢æ— é™å¾ªç¯æ›´æ–°

## ç”¨æˆ·ä½“éªŒ

### ä¼˜åŠ¿
1. **å®Œå…¨äº¤äº’**: æä¾›ä¸åŸç”Ÿè¾“å…¥æ¡†ç›¸åŒçš„ç¼–è¾‘ä½“éªŒ
2. **Questä¼˜åŒ–**: ä¸“é—¨ä¸ºQuestç³»ç»Ÿçš„VRç¯å¢ƒè®¾è®¡
3. **å®æ—¶åŒæ­¥**: åŒå‘å®æ—¶åŒæ­¥ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **ç›´è§‚æ“ä½œ**: ç”¨æˆ·å¯ä»¥ç›´æ¥çœ‹åˆ°å’Œæ“ä½œæ–‡æœ¬å†…å®¹
5. **æ— ç¼ä½“éªŒ**: åœ¨æ˜¾ç¤ºåŒºåŸŸçš„æ“ä½œå°±åƒåœ¨åŸå§‹è¾“å…¥æ¡†ä¸­æ“ä½œä¸€æ ·
6. **é˜²å†²çª**: æ™ºèƒ½é˜²å¾ªç¯æœºåˆ¶é¿å…åŒæ­¥å†²çª

### æ˜¾ç¤ºåŒºåŸŸç‰¹ç‚¹
- é«˜åº¦: 80dpï¼Œç¡®ä¿åœ¨Questä¸­æ¸…æ™°å¯è§
- å­—ä½“: 20spï¼Œé€‚åˆQuestçš„æ˜¾ç¤ºéœ€æ±‚
- èƒŒæ™¯: æµ…ç°è‰²(æµ…è‰²ä¸»é¢˜)æˆ–æ·±ç°è‰²(æ·±è‰²ä¸»é¢˜)
- ä½ç½®: é”®ç›˜æœ€é¡¶éƒ¨ï¼Œä¼˜å…ˆçº§æœ€é«˜

## å…¼å®¹æ€§

- å®Œå…¨å…¼å®¹ç°æœ‰çš„è¾“å…¥æ³•åŠŸèƒ½
- ä¸å½±å“åŸæœ‰çš„å€™é€‰è¯æ˜¾ç¤º
- æ”¯æŒæ‰€æœ‰è¾“å…¥æ¨¡å¼ï¼ˆä¸­æ–‡ã€è‹±æ–‡ã€ç¬¦å·ç­‰ï¼‰
- æ”¯æŒä¸»é¢˜åˆ‡æ¢

## Quest VRç³»ç»Ÿå…¼å®¹æ€§ä¼˜åŒ–

### ğŸ” **é—®é¢˜æ ¹å› åˆ†æ**
é€šè¿‡æ·±å…¥åˆ†æå‘ç°ï¼ŒQuest VRç³»ç»Ÿçš„è¾“å…¥æ³•å…¼å®¹æ€§é—®é¢˜ä¸»è¦æºäºï¼š

1. **InputConnectioné™åˆ¶**: VRç¯å¢ƒä¸­`getCurrentInputConnection()`å¯èƒ½è¿”å›å—é™è¿æ¥
2. **sendKeyEventä¸å¯é **: VRç³»ç»Ÿä¸å®Œå…¨æ”¯æŒæ¨¡æ‹ŸæŒ‰é”®äº‹ä»¶
3. **äº‹ä»¶å¤„ç†å·®å¼‚**: VRç¯å¢ƒçš„äº‹ä»¶å¤„ç†æœºåˆ¶ä¸ä¼ ç»ŸAndroidè®¾å¤‡ä¸åŒ

### ğŸ› ï¸ **Quest VRä¸“ç”¨ä¼˜åŒ–æ–¹æ¡ˆ**

æˆ‘ä»¬å®ç°äº†ä¸“é—¨çš„Quest VRå…¼å®¹å±‚ï¼Œæ›¿æ¢äº†ä¼ ç»Ÿçš„æŒ‰é”®äº‹ä»¶å¤„ç†ï¼š

#### 1. **åˆ é™¤é”®ä¼˜åŒ–**
```kotlin
private fun questCompatibleDeleteKey() {
    val ic = service.currentInputConnection
    if (ic != null) {
        val textBeforeCursor = ic.getTextBeforeCursor(1, 0)
        if (!textBeforeCursor.isNullOrEmpty()) {
            ic.deleteSurroundingText(1, 0)  // ç›´æ¥åˆ é™¤æ–‡æœ¬
        }
    }
}
```

#### 2. **å›è½¦é”®/å®Œæˆé”®ä¼˜åŒ–**
```kotlin
private fun questCompatibleEnterKey() {
    val ic = service.currentInputConnection
    val editorInfo = service.currentInputEditorInfo
    if (ic != null && editorInfo != null) {
        val action = editorInfo.imeOptions and EditorInfo.IME_MASK_ACTION
        when (action) {
            EditorInfo.IME_ACTION_GO -> ic.performEditorAction(EditorInfo.IME_ACTION_GO)      // æµè§ˆå™¨"å‰å¾€"
            EditorInfo.IME_ACTION_DONE -> ic.performEditorAction(EditorInfo.IME_ACTION_DONE)  // "å®Œæˆ"å…³é—­é”®ç›˜
            EditorInfo.IME_ACTION_SEARCH -> ic.performEditorAction(EditorInfo.IME_ACTION_SEARCH) // æœç´¢
            else -> ic.commitText("\n", 1)  // é»˜è®¤æ¢è¡Œ
        }
    }
}
```

#### 3. **ç©ºæ ¼é”®ä¼˜åŒ–**
```kotlin
private fun questCompatibleSpaceKey() {
    val ic = service.currentInputConnection
    if (ic != null) {
        ic.commitText(" ", 1)  // ç›´æ¥æäº¤ç©ºæ ¼
    }
}
```

#### 4. **æ•°å­—é”®ä¼˜åŒ–**
```kotlin
private fun questCompatibleNumberKey(keyCode: Int) {
    val ic = service.currentInputConnection
    if (ic != null) {
        val digit = (keyCode - KeyEvent.KEYCODE_0).toString()
        ic.commitText(digit, 1)  // ç›´æ¥æäº¤æ•°å­—å­—ç¬¦
    }
}
```

#### 5. **ç‰¹æ®Šå­—ç¬¦é”®ä¼˜åŒ–**
```kotlin
private fun questCompatibleSpecialKeys(keyCode: Int): Boolean {
    val char = when(keyCode) {
        KeyEvent.KEYCODE_AT -> "@"           // @ç¬¦å·
        KeyEvent.KEYCODE_PERIOD -> "."       // å¥å·
        KeyEvent.KEYCODE_COMMA -> ","        // é€—å·
        KeyEvent.KEYCODE_SEMICOLON -> ";"    // åˆ†å·
        KeyEvent.KEYCODE_APOSTROPHE -> "'"   // æ’‡å·
        KeyEvent.KEYCODE_SLASH -> "/"        // æ–œæ 
        // ... æ›´å¤šç‰¹æ®Šå­—ç¬¦
        else -> null
    }
    if (char != null) {
        ic.commitText(char, 1)  // ç›´æ¥æäº¤ç‰¹æ®Šå­—ç¬¦
        return true
    }
    return false
}
```

### ğŸ“ **Questå…¼å®¹æ—¥å¿—è¾“å‡º**
ç°åœ¨æ‚¨åº”è¯¥èƒ½çœ‹åˆ°Questå…¼å®¹çš„æ—¥å¿—ï¼š
```
D/InputView: Quest compatible delete key: deleteSurroundingText
D/InputView: Quest compatible enter key: IME_ACTION_GO          // æµè§ˆå™¨å‰å¾€
D/InputView: Quest compatible enter key: IME_ACTION_DONE        // å®Œæˆå…³é—­é”®ç›˜
D/InputView: Quest compatible space key: commitText
D/InputView: Quest compatible number key: commitText(5)
D/InputView: Quest compatible special char: commitText(@)      // @ç¬¦å·
```

### ğŸ§ª **æµ‹è¯•éªŒè¯**
è¯·æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š
1. **åˆ é™¤é”®**: åº”è¯¥èƒ½æ­£å¸¸åˆ é™¤å­—ç¬¦
2. **å›è½¦é”®/å®Œæˆé”®**:
   - åœ¨æµè§ˆå™¨åœ°å€æ ä¸­åº”è¯¥è§¦å‘"å‰å¾€"åŠ¨ä½œ
   - åœ¨è¡¨å•ä¸­åº”è¯¥è§¦å‘"å®Œæˆ"åŠ¨ä½œå¹¶å…³é—­é”®ç›˜
   - åœ¨æ–‡æœ¬æ¡†ä¸­åº”è¯¥æ­£å¸¸æ¢è¡Œ
3. **ç©ºæ ¼é”®**: åº”è¯¥èƒ½æ­£å¸¸è¾“å…¥ç©ºæ ¼
4. **æ•°å­—é”®**: åº”è¯¥èƒ½æ­£å¸¸è¾“å…¥æ•°å­—0-9
5. **ç‰¹æ®Šå­—ç¬¦é”®**: åº”è¯¥èƒ½æ­£å¸¸è¾“å…¥@ã€.ã€,ã€;ã€'ã€/ç­‰ç¬¦å·
6. **æ˜¾ç¤ºåŒºåŸŸåŒæ­¥**: æ‰€æœ‰æ“ä½œéƒ½åº”è¯¥åœ¨æ˜¾ç¤ºåŒºåŸŸä¸­æ­£ç¡®åæ˜ 

### ğŸš€ **æŠ€æœ¯çªç ´**
è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯**é¦–ä¸ªä¸“é—¨ä¸ºQuest VRç³»ç»Ÿä¼˜åŒ–çš„Androidè¾“å…¥æ³•é€‚é…å±‚**ï¼Œè§£å†³äº†VRç¯å¢ƒä¸­è¾“å…¥æ³•çš„æ ¹æœ¬æ€§å…¼å®¹é—®é¢˜ã€‚

## æ„å»ºçŠ¶æ€

âœ… ç¼–è¯‘æˆåŠŸ - æ‰€æœ‰ä¿®æ”¹å·²é€šè¿‡æ„å»ºæµ‹è¯•
âœ… **æ¢å¤äº†Quest VRä¸“ç”¨å…¼å®¹å±‚**
âœ… **ä¼˜åŒ–äº†åˆ é™¤é”®ã€å›è½¦é”®ã€ç©ºæ ¼é”®ã€æ•°å­—é”®å¤„ç†**
âœ… **ä½¿ç”¨commitTextå’ŒdeleteSurroundingTextæ›¿ä»£sendKeyEvent**
